# GraphRAG発想支援システム 動作仕様

---

## 1. システム概要

### 1.1 目的と特徴

本システムは、テレビ番組企画における創造的発想を支援するGraphRAGベースのCLIツールである。

| 特徴 | 説明 |
|------|------|
| **排他的マルチ戦略検索** | 7つの検索戦略が順次実行され、重複を排除して多様な番組を発見 |
| **LLM動的スコアリング** | ユーザー入力からLLMが最適なスコアリングポリシーを自動設定 |
| **LLMリランキング** | 上位候補をLLMが再評価し、文脈適合性で最終順位を決定 |
| **マルチペルソナ分析** | 4つの専門家視点から多角的なアドバイスを生成 |

### 1.2 技術スタック

```
┌─────────────────────────────────────────────────────────┐
│  フロントエンド: Python CLI (graphrag_cli_ChatGPT.py)   │
├─────────────────────────────────────────────────────────┤
│  LLM: OpenAI GPT-5.1 (gpt-5.1)                │
│  - 意図分析・スコアリングポリシー生成                    │
│  - リランキング・マルチペルソナアドバイス生成             │
├─────────────────────────────────────────────────────────┤
│  グラフDB: Neo4j 5.20.0 + neosemantics (n10s)          │
│  - RDF-Star形式でテレビ番組知識グラフを格納              │
│  - Cypherクエリによる構造的検索                         │
└─────────────────────────────────────────────────────────┘
```

---

## 2. 排他的マルチ戦略検索（v4.0コア機能）

### 2.1 排他検索の仕組み

各検索戦略は**順次実行**され、前の戦略で取得した番組タイトルを**除外**して検索する。これにより重複を防ぎ、多様な番組候補を効率的に収集する。

```
戦略1 → 結果A（25件）
    ↓ Aを除外リストに追加
戦略2 → 結果B（20件、Aと重複なし）
    ↓ A+Bを除外リストに追加
戦略3 → 結果C（20件、A+Bと重複なし）
    ...
```

**Neo4jクエリでの除外実装:**
```cypher
WHERE NOT p.tv__title[0] IN $excludeTitles
```

※ n10sプラグインはプロパティを配列として格納するため、`[0]`でアクセス

### 2.2 7つの検索戦略

| # | 戦略名 | 取得上限 | 特徴 |
|:-:|--------|:------:|------|
| 1 | **similar_content** | 25件 | 主要キーワードをAND条件で厳密マッチ |
| 2 | **emotion_based** | 20件 | 感情ベース検索（主要キーワード除外） |
| 3 | **element_combination** | 20件 | 構成要素検索（感情条件除外） |
| 4 | **timeslot_success** | 15件 | 放送枠×ターゲット層マッチング |
| 5 | **contrast_search** | 15件 | 全キーワード除外（セレンディピティ発見） |
| 6 | **similar_format** | 15件 | フォーマットベース検索 |
| 7 | **cross_genre** | 15件 | 異ジャンル横断検索 |

### 2.3 戦略別の検索条件

**similar_content（類似コンテンツ検索）**
```cypher
// 主要キーワードをAND条件で結合（厳密マッチ）
WHERE (p.tv__title[0] CONTAINS '名古屋' OR p.tv__description[0] CONTAINS '名古屋')
  AND (p.tv__title[0] CONTAINS '地域密着' OR p.tv__description[0] CONTAINS '地域密着')
  AND NOT p.tv__title[0] IN $excludeTitles
ORDER BY p.tv__title[0]  // アルファベット順
LIMIT 25
```

**emotion_based（感情ベース検索）**
```cypher
// 期待感情でマッチ、主要キーワードを除外
MATCH (p:ns0__Program)-[:ns0__evokesEmotion]->(e:ns0__ViewerEmotion)
WHERE e.rdfs__label[0] CONTAINS $expectedEmotion
  AND NOT (p.tv__title[0] CONTAINS $primaryKeyword1)
  AND NOT p.tv__title[0] IN $excludeTitles
ORDER BY rand()  // ランダム順
LIMIT 20
```

**contrast_search（コントラスト検索）**
```cypher
// ずらしパターン必須、全キーワード除外でセレンディピティを発見
MATCH (p:ns0__Program)-[:ns0__appliesShift]->(sp:ns0__ShiftPattern)
WHERE NOT (p.tv__title[0] CONTAINS $anyKeyword)
  AND NOT p.tv__title[0] IN $excludeTitles
ORDER BY rand()
LIMIT 15
```

### 2.4 検索効率の改善効果

| モード | 取得番組数 | ユニーク数 | 効率 |
|--------|:--------:|:--------:|:----:|
| 従来（重複あり） | 130件 | 30件 | 23% |
| **排他モード** | 130件 | **87件以上** | **67%+** |

---

## 3. LLM動的スコアリング（v3.3）

### 3.1 概要

ユーザーの自由入力をLLMが分析し、検索・スコアリングに必要なパラメータを自動生成する。

```
ユーザー入力（自由文）
    ↓ LLM分析
スコアリングポリシー（JSON）
    ↓ 
検索実行 + スコア計算
```

### 3.2 LLMが生成するスコアリングポリシー

```json
{
  "program_type": "地域バラエティ",
  "station_preference": "local_preferred",
  "positive_genres": ["地域情報バラエティ", "街歩き紀行", "グルメバラエティ"],
  "negative_genres": ["深夜バラエティ", "ギャンブル番組"],
  "positive_elements": ["地域住民出演", "視聴者参加", "ご近所ロケ"],
  "scoring_weights": {
    "timeslot": 0.22,
    "target": 0.18,
    "genre": 0.15,
    "station": 0.15,
    "keyword": 0.12,
    "format": 0.08,
    "element": 0.05,
    "emotion": 0.05
  }
}
```

### 3.3 局プリファレンス

| 設定 | ローカル局 | 全国キー局 | 用途 |
|------|:--------:|:--------:|------|
| `local_preferred` | **+0.30** | -0.10 | 地域密着番組 |
| `national_preferred` | -0.10 | +0.20 | 全国放送企画 |
| `neutral` | 0 | 0 | 中立 |

### 3.4 ネガティブフィルター

`negative_genres`に該当する番組は**スコアリング前に除外**される（ペナルティではなく完全除外）。

```python
# 実装例
if any(neg in program_genres for neg in negative_genres):
    continue  # この番組をスキップ
```

---

## 4. LLMリランキング

### 4.1 処理フロー

```
スコア上位30件
    ↓ LLMに送信
LLMが文脈適合性を評価
    ↓
最終順位 + 選定理由（30文字）
```

### 4.2 リランキング評価基準

LLMは以下の観点で候補を再評価する：

1. **放送枠適合性**（最重要）: 時間帯・曜日の一致度
2. **ターゲット親和性**: 視聴者層との適合
3. **ジャンル・フォーマット類似性**: 構造的な参考価値
4. **セレンディピティ**: 意外性のある発見価値

### 4.3 出力形式

```
順位: 1
番組名: PS純金
選定理由: 中京テレビ制作で名古屋エリアの家族視聴に最適
```

---

## 5. 処理フロー（5ステップ）

```
┌─────────────────────────────────────────────────────────────────┐
│                    GraphRAG処理フロー v4.0                       │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Step 1: 自由入力                                                │
│  ┌─────────────────────────────────────────────────────┐        │
│  │  ユーザーが企画意図を自由文で入力（複数行可）          │        │
│  │  例: 「日曜10時、ファミリー向け、名古屋の街歩き...」   │        │
│  └─────────────────────────────────────────────────────┘        │
│         ↓                                                       │
│  Step 2: LLM意図分析                                             │
│  ┌─────────────────────────────────────────────────────┐        │
│  │  LLMが自由文から以下を抽出:                           │        │
│  │  - 放送枠・ターゲット層                               │        │
│  │  - 主要/副次キーワード、回避キーワード                │        │
│  │  - 検索戦略の選択                                     │        │
│  │  - スコアリングポリシー（局プリファレンス等）         │        │
│  └─────────────────────────────────────────────────────┘        │
│         ↓                                                       │
│  Step 3: GraphRAG検索 + スコアリング + リランキング              │
│  ┌─────────────────────────────────────────────────────┐        │
│  │  (1) 排他的マルチ戦略検索（7戦略順次実行）            │        │
│  │  (2) 統一スコアリング（LLM設定のポリシー適用）        │        │
│  │  (3) ネガティブフィルター適用                         │        │
│  │  (4) LLMリランキング（上位30件→最終10件）            │        │
│  └─────────────────────────────────────────────────────┘        │
│         ↓                                                       │
│  Step 4: ずらしパターン選択                                      │
│  ┌─────────────────────────────────────────────────────┐        │
│  │  - 方向性算出（冒険度×独創性）                        │        │
│  │  - 14パターンから推奨提示                             │        │
│  │  - ずらし度（0-100）の設定                            │        │
│  └─────────────────────────────────────────────────────┘        │
│         ↓                                                       │
│  Step 5: マルチペルソナアドバイス生成                            │
│  ┌─────────────────────────────────────────────────────┐        │
│  │  4つの専門家視点でアドバイス生成                      │        │
│  │  → 統合シンセシス（次のアクション提案）               │        │
│  └─────────────────────────────────────────────────────┘        │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## 6. マルチペルソナ分析（v3.2）

### 6.1 4つの専門家ペルソナ

| ペルソナ | 役割 | 分析観点 |
|----------|------|---------|
| **敏腕プロデューサー** | 制作実務 | キャスティング、演出、予算配分、撮影計画 |
| **編成部長** | 編成戦略 | 放送枠適合性、競合分析、シーズン戦略 |
| **メディアアナリスト** | デジタル戦略 | SNS連動、TVerコンテンツ、若年層リーチ |
| **社会課題コンサルタント** | 社会的価値 | SDGs、地域貢献、スポンサー価値、多様性 |

### 6.2 出力フォーマット

各ペルソナが以下の構造でアドバイスを生成：

```
【敏腕プロデューサーの視点】
■ 核心的な提案
「家族が主役」のキャスティング戦略...

■ 具体的なアクションプラン
1. ファミリー出演者のキャスティング
2. ゴール設定型の企画構成
3. リアルタイムSNS参加システム

■ 予算・リソースの最適化
30分ベース + 月1回60分生放送SP...
```

### 6.3 統合シンセシス

4ペルソナのアドバイスをLLMが統合し、実行可能な次のステップを提案：

```
【統合シンセシス】
コア: 「普通の名古屋家族が主役になるご近所冒険」

キーポイント:
(1) リアル家族が主人公 → 「自分もできそう」感の創出
(2) チャレンジ型フォーマット → 日曜朝の行動喚起
(3) 参加型プラットフォーム → TV×地域コミュニティ接続

次のアクション:
1. パイロット版フォーマット作成
2. キャスティングテスト
3. テスト撮影（1-2家族）
4. デジタル連動プロトタイプ
5. ステークホルダーヒアリング
```

---

## 7. 実行例

### 7.1 入力例

```
【番組タイトル】なごや再発見！ご近所探検隊
【放送枠】日曜10:00（90分・単発特番）
【ターゲット】ファミリー層（小学生を含む親子〜40代）
【コンセプト】
名古屋市内の「意外と知らないご近所の魅力」を家族で探検。
地元商店街の隠れた名店、歴史スポット、ものづくり職人を訪問。
クイズラリー形式で視聴者参加型に。
```

### 7.2 LLM意図分析結果

```json
{
  "timeslot": "日曜10:00",
  "dayType": "週末",
  "targetAudience": "ファミリー層",
  "primaryKeywords": ["名古屋", "地域密着", "家族参加", "ご近所探検"],
  "secondaryKeywords": ["隠れた名店", "歴史スポット", "職人", "クイズラリー", ...],
  "avoidKeywords": ["深夜向け", "過激なドッキリ", "下ネタ"],
  "adventureLevel": 45,
  "originalityLevel": 60,
  "expectedEmotion": "体験と代理満足",
  "selectedStrategies": ["similar_content", "emotion_based", "element_combination"]
}
```

### 7.3 検索結果（排他モード）

```
=== 検索戦略別結果 ===
[1] similar_content:    25件取得 → 25件新規（100%効率）
[2] emotion_based:      20件取得 → 20件新規（100%効率）
[3] element_combination: 20件取得 → 20件新規（100%効率）

合計: 65件 → ネガティブフィルター後: 61件（4件除外）
```

### 7.4 スコアリング結果（上位3件）

```
┌────┬──────────────────────────────┬────────┬─────────────┬──────────────────────────┐
│順位│ 番組名                        │ スコア │ 検索戦略     │ 内訳                      │
├────┼──────────────────────────────┼────────┼─────────────┼──────────────────────────┤
│ 1  │ #しゃにむにロック             │ 0.52   │ similar_    │ KW=0.04, 局=+0.30,       │
│    │ 〜型破りな女たち〜（中京TV）  │        │ content     │ Elem=0.18                │
├────┼──────────────────────────────┼────────┼─────────────┼──────────────────────────┤
│ 2  │ PS純金（中京TV）              │ 0.48   │ emotion_    │ KW=0.08, 局=+0.30,       │
│    │                              │        │ based       │ Genre=0.10               │
├────┼──────────────────────────────┼────────┼─────────────┼──────────────────────────┤
│ 3  │ オモウマい店（中京TV）        │ 0.45   │ element_    │ KW=0.06, 局=+0.30,       │
│    │                              │        │ combination │ Format=0.09              │
└────┴──────────────────────────────┴────────┴─────────────┴──────────────────────────┘
```

**注目点**: `station_preference: local_preferred`により、中京テレビ制作番組が+0.30のボーナスを獲得

### 7.5 LLMリランキング理由

```
#1 #しゃにむにロック: 「中京テレビ制作で名古屋エリア若年層の感覚を把握」
#2 PS純金: 「地域密着グルメの成功フォーマットを参照可能」
#3 オモウマい店: 「店主の人間性フォーカスは家族番組に応用可」
```

---

## 8. ずらしパターン（14種類）

### 8.1 パターン一覧

| # | パターン名 | SCAMPER | 説明 | リスク |
|:-:|-----------|:-------:|------|:------:|
| 1 | 対象の転換 | S | 焦点を別の要素に移動 | 中 |
| 2 | 役割の反転 | R | 主客を入れ替え | 中 |
| 3 | 視点の移動 | S | 誰の視点かを変更 | 低 |
| 4 | スケールの拡大 | M | 規模・時間を拡大 | 低 |
| 5 | スケールの縮小 | M | 規模・時間を縮小 | 低 |
| 6 | 時間軸の変更 | R | 過去↔現在の入替 | 中 |
| 7 | 要素の移植 | P | 他ジャンルから転用 | 高 |
| 8 | 要素の組み合わせ | C | 異要素の掛け合わせ | 中 |
| 9 | 要素の削除 | E | 当たり前を削る | 高 |
| 10 | 制約の追加 | A | 条件・ルールを付加 | 低 |
| 11 | 構造の再配置 | R | 順序・配置を変更 | 中 |
| 12 | 参加者の変更 | S | 出演者属性を変更 | 中 |
| 13 | 場所の転換 | S | 舞台設定を変更 | 低 |
| 14 | 目的の転換 | S | ゴールを変更 | 中 |

### 8.2 方向性の算出

```python
change_score = (adventure_level + originality_level) / 2

if change_score <= 25:
    direction = "磨き上げ志向"
    patterns = ["スケールの拡大", "スケールの縮小", "制約の追加"]
elif change_score <= 45:
    direction = "ひとひねり志向"
    patterns = ["視点の移動", "参加者の変更", "場所の転換"]
elif change_score <= 65:
    direction = "掛け合わせ志向"  # ← 実行例はここ
    patterns = ["要素の組み合わせ", "要素の移植"]
elif change_score <= 85:
    direction = "逆転志向"
    patterns = ["役割の反転", "対象の転換", "目的の転換"]
else:
    direction = "開拓志向"
    patterns = ["要素の削除", "構造の再配置", "時間軸の変更"]
```

### 8.3 ずらし度スケール（0-100）

| 範囲 | 意味 | 推奨状況 |
|:----:|------|---------|
| 0-25 | 軽微なずらし | 安定志向、既存番組の改良 |
| 26-40 | 適度なずらし | 定番+ひとひねり |
| 41-60 | 標準的なずらし | 効果的な創造的転換 |
| 61-75 | 大胆なずらし | 挑戦的な新企画 |
| 76-100 | 極端なずらし | ハイリスク・ハイリターン |

---

## 9. Neo4j/RDF-Starデータ構造

### 9.1 主要ノードラベル

| ラベル | 説明 | 主要プロパティ |
|--------|------|---------------|
| `ns0__Program` | 番組 | title, description, startDate, productionStation |
| `ns0__Timeslot` | 放送枠 | dayOfWeek, hour, dayType, viewingMode |
| `ns0__TargetAudience` | ターゲット層 | name, ageRange, lifestyle |
| `ns0__Genre` | ジャンル | name |
| `ns0__ProgramFormat` | フォーマット | name, structure |
| `ns0__ProductionElement` | 構成要素 | name, category |
| `ns0__ViewerEmotion` | 視聴感情 | name, category, description |
| `ns0__ShiftPattern` | ずらしパターン | name, scamperElement, riskLevel |

### 9.2 主要リレーション

```
(Program)-[:ns0__hasTimeslot]->(Timeslot)
(Program)-[:ns0__hasTarget]->(TargetAudience)
(Program)-[:ns0__belongsTo]->(Genre)
(Program)-[:ns0__hasFormat]->(ProgramFormat)
(Program)-[:ns0__hasElement]->(ProductionElement)
(Program)-[:ns0__evokesEmotion]->(ViewerEmotion)
(Program)-[:ns0__appliesShift]->(ShiftPattern)
```

### 9.3 n10sプロパティアクセスの注意点

neosemanticsプラグインは**プロパティを配列として格納**する：

```cypher
// NG: 直接アクセス
WHERE p.tv__title = '番組名'

// OK: 配列インデックスでアクセス
WHERE p.tv__title[0] = '番組名'
```

---

## 付録A: CLIコマンド一覧

### 基本実行

```bash
# 標準実行
python graphrag_cli_ChatGPT.py

# デバッグモード（詳細ログ出力）
python graphrag_cli_ChatGPT.py --debug

# 特定のNeo4j接続
python graphrag_cli_ChatGPT.py --neo4j-uri bolt://localhost:7687
```

### 環境変数

```bash
export NEO4J_URI="bolt://localhost:7687"
export NEO4J_USER="neo4j"
export NEO4J_PASSWORD="password"
export OPENAI_API_KEY="sk-..."
```

---

## 付録B: スコアリング計算式

### 統一スコア算出

```python
score = (
    timeslot_score * weights['timeslot'] +    # 放送枠一致度
    target_score * weights['target'] +         # ターゲット適合度
    genre_score * weights['genre'] +           # ジャンル一致度
    station_bonus +                            # 局プリファレンス
    keyword_score * weights['keyword'] +       # キーワード一致度
    format_score * weights['format'] +         # フォーマット類似度
    element_score * weights['element'] +       # 構成要素一致度
    emotion_score * weights['emotion']         # 感情一致度
)
```

### キーワードスコア

```python
primary_weight = 0.12    # 主要キーワード1つあたり
secondary_weight = 0.04  # 副次キーワード1つあたり

keyword_score = (
    primary_matches * primary_weight +
    secondary_matches * secondary_weight
)
```

---

## 付録C: バージョン履歴

| バージョン | 主な変更点 |
|-----------|-----------|
| v1.0 | 基本設計、6検索戦略 |
| v3.2 | マルチペルソナ分析追加 |
| v3.3 | LLM動的スコアリング追加 |
| **v4.0** | 排他的検索、LLMリランキング、7戦略化 |

---

## 参考文献

1. Nonaka, I., "A Dynamic Theory of Organizational Knowledge Creation", Organization Science, 1994
2. Smith, G. F., "Idea-Generation Techniques: A Formulary of Active Ingredients", Journal of Creative Behavior, 1998
3. Pan, Z., et al., "Guiding Generative Storytelling with Knowledge Graphs", arXiv:2505.24803, 2025
